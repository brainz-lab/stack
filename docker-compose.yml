# Brainz Lab Stack - Self-Hosted Deployment
# ==========================================
#
# Quick start:
#   ./scripts/setup.sh
#   ./scripts/start.sh
#
# Access via subdomains (add to /etc/hosts):
#   recall.localhost  → Recall (logging)
#   reflex.localhost  → Reflex (errors)
#   pulse.localhost   → Pulse (APM)
#
# Or via ports:
#   http://localhost:3001 → Recall
#   http://localhost:3002 → Reflex
#   http://localhost:3003 → Pulse
#
# Traefik dashboard: http://localhost:8080

services:
  # ============================================
  # TRAEFIK - Reverse Proxy
  # ============================================
  traefik:
    image: traefik:v3.0
    container_name: brainzlab-traefik
    restart: unless-stopped
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/routes.yml:/etc/traefik/routes.yml:ro

  # ============================================
  # INFRASTRUCTURE
  # ============================================
  timescaledb:
    image: timescale/timescaledb:latest-pg16
    container_name: brainzlab-timescaledb
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-brainzlab}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-brainzlab}
      POSTGRES_DB: ${POSTGRES_DB:-brainzlab}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres/init:/docker-entrypoint-initdb.d:ro
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-brainzlab}"]
      interval: 10s
      timeout: 5s
      retries: 5
    command: >
      postgres
      -c shared_preload_libraries=timescaledb
      -c timescaledb.telemetry_level=off

  redis:
    image: redis:7-alpine
    container_name: brainzlab-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "${REDIS_PORT:-6379}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # RECALL - Structured Logging
  # ============================================
  recall:
    image: ${RECALL_IMAGE:-brainzllc/recall:latest}
    container_name: brainzlab-recall
    restart: unless-stopped
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER:-brainzlab}:${POSTGRES_PASSWORD:-brainzlab}@timescaledb:5432/recall
      REDIS_URL: redis://redis:6379/1
      RAILS_ENV: production
      RAILS_MASTER_KEY: ${RECALL_MASTER_KEY}
      SECRET_KEY_BASE: ${RECALL_SECRET_KEY}
      RECALL_MASTER_KEY: ${RECALL_INGEST_KEY}
    ports:
      - "${RECALL_PORT:-3001}:3000"
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy

  # ============================================
  # REFLEX - Error Tracking
  # ============================================
  reflex:
    image: ${REFLEX_IMAGE:-brainzllc/reflex:latest}
    container_name: brainzlab-reflex
    restart: unless-stopped
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER:-brainzlab}:${POSTGRES_PASSWORD:-brainzlab}@timescaledb:5432/reflex
      REDIS_URL: redis://redis:6379/2
      RAILS_ENV: production
      RAILS_MASTER_KEY: ${REFLEX_MASTER_KEY}
      SECRET_KEY_BASE: ${REFLEX_SECRET_KEY}
      REFLEX_MASTER_KEY: ${REFLEX_INGEST_KEY}
    ports:
      - "${REFLEX_PORT:-3002}:3000"
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy

  # ============================================
  # PULSE - APM & Performance Monitoring
  # ============================================
  pulse:
    image: ${PULSE_IMAGE:-brainzllc/pulse:latest}
    container_name: brainzlab-pulse
    restart: unless-stopped
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER:-brainzlab}:${POSTGRES_PASSWORD:-brainzlab}@timescaledb:5432/pulse
      REDIS_URL: redis://redis:6379/3
      RAILS_ENV: production
      RAILS_MASTER_KEY: ${PULSE_MASTER_KEY}
      SECRET_KEY_BASE: ${PULSE_SECRET_KEY}
      PULSE_MASTER_KEY: ${PULSE_INGEST_KEY}
    ports:
      - "${PULSE_PORT:-3003}:3000"
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy

volumes:
  postgres_data:
  redis_data:
